<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DASHBOARD DIARIO DPW/CACHOEIRO</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body { margin:0; font-family:Segoe UI,sans-serif; background:#f3f4f6; }
header { background:#000; color:#fff; text-align:center; padding:12px; font-size:22px; font-weight:bold; }
.tabs { display:flex; background:#111827; }
.tabs button { flex:1; padding:10px; border:none; background:none; color:#fff; cursor:pointer; }
.tabs button.active { background:#1f2937; }
.container { padding:20px; }
.filtros { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px; align-items:center; }
select,input { padding:6px; border-radius: 4px; border: 1px solid #ccc; }
.kpi-container { display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:25px; }
.kpi { color:white; padding:20px; border-radius:10px; text-align:center; }
.kpi h3{margin:0;font-size:14px;} .kpi span{font-size:26px;font-weight:bold;display:block;margin-top:8px;}
.blue{background:#2563eb;} .red{background:#dc2626;} .orange{background:#f59e0b;} .green{background:#15803d;}
.purple{background:#7c3aed;} .teal{background:#0d9488;} .pink{background:#be185d;} .gray{background:#4b5563;}
.grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(350px,1fr)); gap:20px; }
.chart-card { background:#fff; padding:20px 20px 25px 20px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.08); height:420px; display:flex; flex-direction:column; }
.chart-card canvas{flex:1;}
.chart-card h4{margin-bottom:10px;}
.card{background:#fff; padding:15px; border-radius:6px; box-shadow:0 4px 10px rgba(0,0,0,0.1); margin-bottom:20px;}
button{padding:6px 12px; border:none; background:#111827; color:#fff; cursor:pointer; border-radius:4px; margin-top:5px;}
.btn-group{display:flex;gap:15px;margin-top:20px;flex-wrap:wrap;}
.btn-primary{background:linear-gradient(135deg,#111827,#1f2937);color:#fff;padding:10px 22px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:0.2s;}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,0.15);}
.btn-secondary{background:#e5e7eb;color:#111827;padding:10px 22px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:0.2s;}
.btn-secondary:hover{background:#d1d5db;}
.lancamento-card{background:#fff;padding:40px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,0.08);max-width:1100px;margin:30px auto;}
.lancamento-card h2{margin-bottom:25px;color:#111827;}
.form-grid{display:grid;grid-template-columns: repeat(auto-fit,minmax(220px,1fr));gap:20px;}
.campo{display:flex;flex-direction:column;}
.campo label{font-weight:600;margin-bottom:6px;color:#374151;}
.campo input,.campo select{padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;transition:0.2s;}
.campo input:focus,.campo select:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,0.15);}
.btn-danger{background:linear-gradient(135deg,#b91c1c,#dc2626);color:#fff;padding:10px 22px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:0.2s;}
.btn-danger:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(220,38,38,0.3);}
.info-badge { background:#e0e7ff; color:#3730a3; padding:8px 12px; border-radius:6px; font-size:12px; font-weight:600; }
.section-divider { margin-top: 30px; margin-bottom: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb; }
.section-title { font-size: 14px; font-weight: 700; color: #374151; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; }
</style>
</head>

<body>

<header>DASHBOARD DIARIO DPW/CACHOEIRO</header>

<div class="tabs">
<button class="active" onclick="trocarAba('dashboard',this)">Dashboard</button>
<button onclick="trocarAba('input',this)">Lan√ßamento</button>
</div>

<div class="container">

<!-- DASHBOARD -->
<div id="dashboard">

<div class="filtros">
    <button class="btn-primary" onclick="tirarPrintDashboard()">üì∏ Tirar Print do Dashboard</button>
    <button class="btn-secondary" onclick="exportarExcelMes()">üìä Exportar Excel do M√™s</button>
<select onchange="filtrarTurno(this.value)">
<option value="TODOS">Todos Turnos</option>
<option value="A">Turno A</option>
<option value="B">Turno B</option>
<option value="C">Turno C</option>
<option value="D">Turno D</option>
</select>

<label>De:</label>
<input type="date" id="dataInicial">
<label>At√©:</label>
<input type="date" id="dataFinal">
<button class="btn-primary" style="margin-top:0" onclick="atualizar()">Aplicar</button>
<span class="info-badge" id="infoPeriodo">üìä Exibindo √∫ltimos 7 dias</span>
</div>

<div class="kpi-container">
<div class="kpi blue"><h3><i class="fas fa-truck-loading"></i> Ve√≠culos Recebidos</h3><span id="totalVeicRec">0</span></div>
<div class="kpi red"><h3><i class="fas fa-truck-fast"></i> Ve√≠culos Expedidos</h3><span id="totalVeicExp">0</span></div>
<div class="kpi orange"><h3><i class="fas fa-trailer"></i> Carreta de Bobina</h3><span id="totalCarretas">0</span></div>
<div class="kpi green"><h3><i class="fas fa-box"></i> Fardos</h3><span id="totalFardos">0</span></div>
<div class="kpi purple"><h3><i class="fas fa-weight-scale"></i> Tons</h3><span id="totalTons">0</span></div>
<div class="kpi teal"><h3><i class="fas fa-pallet"></i> Paletes</h3><span id="totalPaletes">0</span></div>
<div class="kpi pink"><h3><i class="fas fa-rotate"></i> Fardos Retrabalhados</h3><span id="totalFardosRet">0</span></div>
<div class="kpi gray"><h3><i class="fas fa-industry"></i> Prensa</h3><span id="totalPrensa">0</span></div>
</div>

<div class="grid">
<div class="chart-card"><h4><i class="fas fa-truck-loading"></i> Ve√≠culos Recebidos</h4><canvas id="recChart"></canvas></div>
<div class="chart-card"><h4><i class="fas fa-truck-fast"></i> Ve√≠culos Expedidos</h4><canvas id="expChart"></canvas></div>
<div class="chart-card"><h4><i class="fas fa-trailer"></i> Carreta de Bobina</h4><canvas id="carretasChart"></canvas></div>
<div class="chart-card"><h4><i class="fas fa-box"></i> Fardos</h4><canvas id="fardosChart"></canvas></div>
<div class="chart-card"><h4><i class="fas fa-weight-scale"></i> Tons</h4><canvas id="tonsChart"></canvas></div>
<div class="chart-card"><h4><i class="fas fa-pallet"></i> Paletes</h4><canvas id="paletesChart"></canvas></div>
<div class="chart-card"><h4><i class="fas fa-rotate"></i> Fardos Retrabalhados</h4><canvas id="fardosRetChart"></canvas></div>
<div class="chart-card"><h4><i class="fas fa-industry"></i> Prensa</h4><canvas id="prensaChart"></canvas></div>
</div>

</div>

<!-- LAN√áAMENTO -->
<div id="input" style="display:none;">
<div class="lancamento-card">
<h2>üìã Lan√ßamento Di√°rio</h2>

<!-- Se√ß√£o: Informa√ß√µes B√°sicas -->
<div class="section-title">Informa√ß√µes B√°sicas</div>
<div class="form-grid">
<div class="campo"><label>üìÖ Data</label><input type="date" id="data"></div>
<div class="campo"><label>üîÑ Turno</label><select id="turno"><option value="A">Turno A</option><option value="B">Turno B</option><option value="C">Turno C</option><option value="D">Turno D</option></select></div>
</div>

<!-- Se√ß√£o: Dados Operacionais -->
<div class="section-divider"></div>
<div class="section-title">Dados Operacionais</div>
<div class="form-grid">
<div class="campo"><label>üöõ Ve√≠culos Recebidos</label><input type="number" id="veicRec"></div>
<div class="campo"><label>üöö Ve√≠culos Expedidos</label><input type="number" id="veicExp"></div>
<div class="campo"><label>üöõ Carretas De Bobinas</label><input type="number" id="carretas"></div>
<div class="campo"><label>üì¶ Fardos</label><input type="number" id="fardosMov"></div>
<div class="campo"><label>‚öñÔ∏è Tons</label><input type="number" id="tonsRec"></div>
<div class="campo"><label>üß± Paletes</label><input type="number" id="paletesRet"></div>
<div class="campo"><label>üîÅ Fardos Retrabalhados</label><input type="number" id="fardosRet"></div>
<div class="campo"><label>üè≠ Prensa</label><input type="number" id="prensa"></div>
</div>

<!-- Se√ß√£o: Dados de Recursos Humanos (Apenas para exporta√ß√£o) -->
<div class="section-divider"></div>
<div class="form-grid">
<div class="campo"><label>üë• HC (Headcount)</label><input type="number" id="hc" placeholder="Ex: 45"></div>
<div class="campo"><label>üìã Absente√≠smo (%)</label><input type="number" id="absenteismo" placeholder="Ex: 5.5" step="0.1"></div>
</div>

<div class="btn-group">
<button class="btn-primary" onclick="adicionar()">üíæ Salvar</button>
<button class="btn-danger" onclick="apagarPorDataETurno()">üóëÔ∏è Apagar por Data e Turno</button>
</div>
</div>
</div>

<script>
Chart.register(ChartDataLabels);

let senhaSistema = "1234";
let dados = [];
let filtroTurno = "TODOS";

// Configurar datas padr√£o para os √∫ltimos 7 dias ao carregar
window.onload = function() {
    const hoje = new Date();
    const seteDiasAtras = new Date();
    seteDiasAtras.setDate(hoje.getDate() - 7);
    
    document.getElementById("dataFinal").value = hoje.toISOString().split('T')[0];
    document.getElementById("dataInicial").value = seteDiasAtras.toISOString().split('T')[0];
    
    // O atualizar() ser√° chamado automaticamente pelo onSnapshot do Firebase quando os dados chegarem
};

function trocarAba(id, botao){
  if(id==="input"){
    let senha = prompt("Digite a senha:");
    if(senha!==senhaSistema){alert("Senha incorreta");return;}
  }
  document.getElementById("dashboard").style.display="none";
  document.getElementById("input").style.display="none";
  document.getElementById(id).style.display="block";
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  botao.classList.add("active");
}

function filtrarTurno(t){ filtroTurno=t; atualizar(); }

async function adicionar(){
  let r = {
    data: document.getElementById("data").value,
    turno: document.getElementById("turno").value,
    veicRec: +document.getElementById("veicRec").value||0,
    veicExp: +document.getElementById("veicExp").value||0,
    carretas: +document.getElementById("carretas").value||0,
    fardosMov: +document.getElementById("fardosMov").value||0,
    tonsRec: +document.getElementById("tonsRec").value||0,
    paletesRet: +document.getElementById("paletesRet").value||0,
    fardosRet: +document.getElementById("fardosRet").value||0,
    prensa: +document.getElementById("prensa").value||0,
    hc: +document.getElementById("hc").value||0,
    absenteismo: +document.getElementById("absenteismo").value||0
  };
  if(!r.data){ alert("Preencha a data"); return; }
  
  if(typeof window.salvarTurno === 'function') {
      await window.salvarTurno(r);
      alert("Salvo com sucesso no Firebase!");
      // Limpar campos
      document.querySelectorAll("#input input").forEach(i => i.value = "");
  } else {
      alert("Erro: Conex√£o com Firebase n√£o inicializada.");
  }
}

function criarGrafico(id, cor){
  return new Chart(document.getElementById(id), {
    type:"bar",
    data:{labels:[], datasets:[{label:"", data:[], backgroundColor:cor, borderRadius:6, maxBarThickness:55, categoryPercentage:0.75, barPercentage:0.85}]},
    options:{
      responsive:true, 
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        tooltip:{
          enabled:true,
          backgroundColor:'rgba(0,0,0,0.8)',
          padding:12,
          displayColors:false,
          callbacks:{
            label:function(context){
              return context.parsed.y.toLocaleString("pt-BR");
            }
          }
        },
        datalabels:{
          display:true,
          color:"#000",
          font:{weight:"bold", size:10},
          anchor:"end",
          align:"top",
          offset:5,
          formatter:function(value){
            return value > 0 ? value.toLocaleString("pt-BR") : "";
          }
        }
      },
      scales:{
        x:{
          grid:{display:false}, 
          ticks:{
            color:"#374151", 
            padding:8
          }
        },
        y:{
          beginAtZero:true, 
          grace:"20%", 
          grid:{color:"#e5e7eb"}, 
          ticks:{
            color:"#6b7280", 
            callback:v=>v.toLocaleString("pt-BR")
          }
        }
      }
    }
  });
}

const recChart = criarGrafico("recChart","#2563eb");
const expChart = criarGrafico("expChart","#dc2626");
const carretasChart = criarGrafico("carretasChart","#f59e0b");
const fardosChart = criarGrafico("fardosChart","#15803d");
const tonsChart = criarGrafico("tonsChart","#7c3aed");
const paletesChart = criarGrafico("paletesChart","#0d9488");
const fardosRetChart = criarGrafico("fardosRetChart","#be185d");
const prensaChart = criarGrafico("prensaChart","#4b5563");

function formatarDataBR(dataISO){
  if(!dataISO) return "";
  let p=dataISO.split("-");
  return `${p[2]}/${p[1]}/${p[0]}`;
}

function atualizar(){
  let di=document.getElementById("dataInicial").value; 
  let df=document.getElementById("dataFinal").value;
  
  let filtrado = dados.filter(d => {
    let ok = true; 
    if(di && d.data < di) ok = false; 
    if(df && d.data > df) ok = false;
    return ok && (filtroTurno === "TODOS" || d.turno === filtroTurno);
  });
  
  // Agrupar por data
  let agrupado = {};
  filtrado.forEach(d => {
      if(!agrupado[d.data]) {
          agrupado[d.data] = {
              data: d.data,
              veicRec: 0, veicExp: 0, carretas: 0, fardosMov: 0,
              tonsRec: 0, paletesRet: 0, fardosRet: 0, prensa: 0
          };
      }
      agrupado[d.data].veicRec += d.veicRec;
      agrupado[d.data].veicExp += d.veicExp;
      agrupado[d.data].carretas += d.carretas;
      agrupado[d.data].fardosMov += d.fardosMov;
      agrupado[d.data].tonsRec += d.tonsRec;
      agrupado[d.data].paletesRet += d.paletesRet;
      agrupado[d.data].fardosRet += d.fardosRet;
      agrupado[d.data].prensa += d.prensa;
  });
  
  let listaAgrupada = Object.values(agrupado).sort((a,b) => new Date(a.data) - new Date(b.data));
  let labels = listaAgrupada.map(d => formatarDataBR(d.data));
  
  function att(chart, campo){ 
      chart.data.labels = labels; 
      chart.data.datasets[0].data = listaAgrupada.map(d => d[campo]); 
      chart.update(); 
  }
  
  att(recChart,"veicRec"); att(expChart,"veicExp"); att(carretasChart,"carretas"); att(fardosChart,"fardosMov");
  att(tonsChart,"tonsRec"); att(paletesChart,"paletesRet"); att(fardosRetChart,"fardosRet"); att(prensaChart,"prensa");
  
  function soma(c){ return filtrado.reduce((t,d) => t + d[c], 0); }
  
  document.getElementById("totalVeicRec").innerText = soma("veicRec").toLocaleString("pt-BR");
  document.getElementById("totalVeicExp").innerText = soma("veicExp").toLocaleString("pt-BR");
  document.getElementById("totalCarretas").innerText = soma("carretas").toLocaleString("pt-BR");
  document.getElementById("totalFardos").innerText = soma("fardosMov").toLocaleString("pt-BR");
  document.getElementById("totalTons").innerText = soma("tonsRec").toLocaleString("pt-BR");
  document.getElementById("totalPaletes").innerText = soma("paletesRet").toLocaleString("pt-BR");
  document.getElementById("totalFardosRet").innerText = soma("fardosRet").toLocaleString("pt-BR");
  document.getElementById("totalPrensa").innerText = soma("prensa").toLocaleString("pt-BR");
  
  let periodoTxt = "üìä Exibindo ";
  if(di && df) periodoTxt += `de ${formatarDataBR(di)} at√© ${formatarDataBR(df)}`;
  else periodoTxt += "todos os dados";
  document.getElementById("infoPeriodo").innerText = periodoTxt;
}

function tirarPrintDashboard(){
    const dashboardElement = document.getElementById('dashboard');
    html2canvas(dashboardElement, {
        scale: 2,
        backgroundColor: "#f3f4f6",
        logging: false,
        useCORS: true
    }).then(canvas => {
        const link = document.createElement('a');
        link.download = `Dashboard_DPW_Cachoeiro_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    });
}

function exportarExcelMes() {
    if (dados.length === 0) {
        alert("N√£o h√° dados para exportar.");
        return;
    }
    const agora = new Date();
    const mesAtual = String(agora.getMonth() + 1).padStart(2, '0');
    const anoAtual = agora.getFullYear();
    const prefixoMes = anoAtual + '-' + mesAtual;
    const dadosMes = dados.filter(d => d.data && d.data.startsWith(prefixoMes));
    
    if(dadosMes.length === 0){
      alert('Nenhum dado encontrado para o m√™s atual (' + mesAtual + '/' + anoAtual + ')');
      return;
    }
    
    // CSV com todas as colunas incluindo HC e Absente√≠smo - com BOM UTF-8 para Excel
    let csv = '\uFEFFData;Turno;Veic Rec;Veic Exp;Carretas;Fardos;Tons;Paletes;Fardos Ret;Prensa;HC;Absente√≠smo (%)\n';
    dadosMes.forEach(d => {
        // Adicionar valores de HC e Absente√≠smo, usando 0 se n√£o existirem
        const hc = d.hc || 0;
        const absenteismo = d.absenteismo || 0;
        csv += `${formatarDataBR(d.data)};${d.turno};${d.veicRec};${d.veicExp};${d.carretas};${d.fardosMov};${d.tonsRec};${d.paletesRet};${d.fardosRet};${d.prensa};${hc};${absenteismo}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `Relatorio_DPW_Cachoeiro_${mesAtual}_${anoAtual}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, onSnapshot, query, orderBy, 
  deleteDoc, doc, getDocs, where 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAAjwidHLuh8aTZsFPmOXoqpbD12pTTElI",
  authDomain: "dashboard-turnos.firebaseapp.com",
  projectId: "dashboard-turnos",
  storageBucket: "dashboard-turnos.firebasestorage.app",
  messagingSenderId: "902554933795",
  appId: "1:902554933795:web:bf86abf00ed58d569aaf96",
  measurementId: "G-R0N3S5T6GD"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const turnosRef = collection(db, "lancamentos");

window.salvarTurno = async function(novosDados){
  await addDoc(turnosRef, {
    ...novosDados,
    criadoEm: new Date()
  });
}

// Atualiza√ß√£o autom√°tica via Firebase
const q = query(turnosRef, orderBy("criadoEm", "desc"));
onSnapshot(q, (snapshot) => {
  dados = [];
  snapshot.forEach(docItem =>
    dados.push({id: docItem.id, ...docItem.data()})
  );
  atualizar();
});

window.apagarPorDataETurno = async function(){
  try {
    let senha = prompt("Digite a senha para apagar:");
    if(senha !== senhaSistema){
      alert("Senha incorreta!");
      return;
    }

    let dataParaApagar = document.getElementById("data").value;
    let turnoParaApagar = document.getElementById("turno").value;

    if(!dataParaApagar){
      alert("Selecione a data antes de apagar.");
      return;
    }

    if(!confirm(`Confirma exclus√£o da data ${dataParaApagar} - Turno ${turnoParaApagar}?`)){
      return;
    }

    const qDelete = query(
      turnosRef,
      where("data", "==", dataParaApagar),
      where("turno", "==", turnoParaApagar)
    );

    const snapshot = await getDocs(qDelete);

    if(snapshot.empty){
      alert("Nenhum registro encontrado para essa data e turno.");
      return;
    }

    const deletePromises = [];
    snapshot.forEach((docSnapshot)=>{
      deletePromises.push(
        deleteDoc(doc(db, "lancamentos", docSnapshot.id))
      );
    });

    await Promise.all(deletePromises);
    alert("Registro(s) apagado(s) com sucesso!");
    
  } catch(erro) {
    console.error("Erro ao apagar:", erro);
    alert("Erro ao apagar: " + erro.message);
  }
}
</script>

</body>
</html>